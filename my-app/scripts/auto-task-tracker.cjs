#!/usr/bin/env node
// ============================================================
// Auto Task Tracker — Git post-commit hook
// Generated by @yattalo/task-system for my-app
// ============================================================

// eslint-disable-next-line @typescript-eslint/no-require-imports
const { execSync } = require("child_process");

// Task ID pattern from config
const TASK_ID_PATTERN = /[CGX]\d{1,3}/g;
const PROJECT_ID = "my-app";

// Status keywords (supports English + Italian)
const DONE_KEYWORDS = [
  "done", "complete", "completed", "finish", "finished", "close", "closed",
  "fix", "fixed", "resolve", "resolved",
  "fatto", "completato", "finito", "chiuso", "risolto",
];
const START_KEYWORDS = [
  "start", "started", "begin", "wip", "working",
  "inizio", "iniziato", "lavoro",
];

function main() {
  try {
    // Get the last commit message
    const message = execSync("git log -1 --pretty=%B", { encoding: "utf-8" }).trim();
    const hash = execSync("git log -1 --pretty=%H", { encoding: "utf-8" }).trim().slice(0, 8);
    const filesRaw = execSync("git diff-tree --no-commit-id --name-only -r HEAD", { encoding: "utf-8" }).trim();
    const files = filesRaw ? filesRaw.split("\n") : [];

    // Extract task IDs from commit message
    const taskIds = [...new Set(message.match(TASK_ID_PATTERN) || [])];
    if (taskIds.length === 0) return;

    const lowerMsg = message.toLowerCase();
    const isDone = DONE_KEYWORDS.some((k) => lowerMsg.includes(k));
    const isStart = START_KEYWORDS.some((k) => lowerMsg.includes(k));

    // Detect agent from git config or environment
    const agent = detectAgent();

    for (const taskId of taskIds) {
      console.log(`[task-tracker] Processing ${taskId} (commit: ${hash})`);

      // Add commit to task
      try {
        execSync(
          `npx convex run taskSystem/tasks:addCommit '${JSON.stringify({
            projectId: PROJECT_ID,
            taskId,
            hash,
            message: message.slice(0, 200),
            filesChanged: files.slice(0, 20),
            agent,
          })}'`,
          { encoding: "utf-8", stdio: "pipe" }
        );
      } catch {
        // addCommit may not exist if commitTracking is disabled
      }

      // Auto status transition
      if (isDone) {
        try {
          execSync(
            `npx convex run taskSystem/tasks:changeStatus '${JSON.stringify({
              projectId: PROJECT_ID,
              taskId,
              newStatus: "done",
              note: `Auto-completed by commit ${hash}`,
              agent,
            })}'`,
            { encoding: "utf-8", stdio: "pipe" }
          );
          console.log(`[task-tracker] ${taskId} → done`);
        } catch (e) {
          console.log(`[task-tracker] Failed to update ${taskId}: ${e.message}`);
        }
      } else if (isStart) {
        try {
          execSync(
            `npx convex run taskSystem/tasks:changeStatus '${JSON.stringify({
              projectId: PROJECT_ID,
              taskId,
              newStatus: "in_progress",
              note: `Auto-started by commit ${hash}`,
              agent,
            })}'`,
            { encoding: "utf-8", stdio: "pipe" }
          );
          console.log(`[task-tracker] ${taskId} → in_progress`);
        } catch (e) {
          console.log(`[task-tracker] Failed to update ${taskId}: ${e.message}`);
        }
      }
    }
  } catch (e) {
    // Never block commits — fail silently
    console.log(`[task-tracker] Warning: ${e.message}`);
  }
}

function detectAgent() {
  // Check environment variables set by agent CLIs
  if (process.env.CLAUDE_CODE) return "claude";
  if (process.env.GEMINI_CLI) return "gemini";
  if (process.env.CODEX_CLI) return "codex";

  // Check git author
  try {
    const author = execSync("git log -1 --pretty=%an", { encoding: "utf-8" }).trim().toLowerCase();
    if (author.includes("claude")) return "claude";
    if (author.includes("gemini")) return "gemini";
    if (author.includes("codex")) return "codex";
  } catch {}

  return "unknown";
}

main();